<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do CEO</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <a href="{{ url_for('index') }}" class="back-button">Voltar</a>
        <h1>Painel do CEO</h1>

        <!-- Controles -->
        <div class="controls">
            <!-- Seletor de Semana -->
            <div class="week-selector">
                <form method="GET" action="{{ url_for('ceo_dashboard') }}">
                    <label>Semana:</label>
                    {% for week in range(1, 5) %}
                        <button 
                            type="submit" 
                            name="week" 
                            value="{{ week }}"
                            class="week-btn {% if selected_week == week|string %}active{% endif %}">
                            Semana {{ week }}
                        </button>
                    {% endfor %}
                    <input type="hidden" name="employee_id" value="{{ selected_employee_id if selected_employee_id else '' }}">
                </form>
            </div>

            <!-- Filtro de Funcionário -->
            <form method="GET" action="{{ url_for('ceo_dashboard') }}" class="employee-filter">
                <label for="employee_id">Funcionário:</label>
                <select id="employee_id" name="employee_id" onchange="this.form.submit()">
                    <option value="">Todos</option>
                    {% for employee in employees %}
                    <option value="{{ employee.id }}" {% if selected_employee_id == employee.id|string %}selected{% endif %}>
                        {{ employee.name }}
                    </option>
                    {% endfor %}
                </select>
                <input type="hidden" name="week" value="{{ selected_week }}">
            </form>
        </div>

        <!-- Progresso dos Funcionários -->
        <h2>Progresso - Semana {{ selected_week }}</h2>
        <div class="progress-container">
            {% for employee in employees %}
            <div class="employee-progress">
                <div class="employee-name">{{ employee.name }}</div>
                
                <div class="progress-info">
                    <div>
                        <strong>Semana:</strong> {{ employee_totals[employee.id]['current_week_points'] }}/2375 pts
                    </div>
                    <div>
                        <strong>Mês:</strong> {{ employee_totals[employee.id]['monthly_total'] }}/9500 pts
                    </div>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar progress-{{ employee_totals[employee.id]['status_color'] }}" 
                        style="width: {{ employee_totals[employee.id]['weekly_percentage']|round(1) }}%">
                    </div>
                </div>
                
                <div class="progress-percentage">
                    {{ employee_totals[employee.id]['weekly_percentage']|round(1) }}% da semana | 
                    {{ employee_totals[employee.id]['monthly_percentage']|round(1) }}% do mês
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Tabela de Registros -->
        <h2>Registros - Semana {{ selected_week }}</h2>
        {% if entries %}
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Funcionário</th>
                    <th>Refinaria</th>
                    <th>Pontos</th>
                    <th>Observações</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td>{{ entry.date }}</td>
                    <td>{{ entry.employee.name }}</td>
                    <td>{{ entry.refinery }}</td>
                    <td>{{ entry.points }}</td>
                    <td>{{ entry.observations }}</td>
                    <td>
                        <a href="{{ url_for('edit_entry', entry_id=entry.id) }}" class="btn">Editar</a>
                        <form method="POST" action="{{ url_for('delete_entry', entry_id=entry.id) }}" style="display:inline;">
                            <button type="submit" class="btn danger" onclick="return confirm('Tem certeza que deseja excluir este registro?')">Excluir</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="no-data">Nenhum registro encontrado para esta semana.</p>
        {% endif %}

        <!-- Ações -->
        <div class="actions">
            <!-- Botão Excluir Tudo -->
            <form id="deleteAllForm" method="POST" action="{{ url_for('delete_all_entries') }}">
                <input type="hidden" name="employee_id" value="{{ selected_employee_id if selected_employee_id else '' }}">
                <input type="hidden" name="week" value="{{ selected_week }}">
                <button type="button" onclick="confirmAction('delete', 'Você tem certeza disso?')" class="btn danger">
                    Excluir Tudo
                </button>
            </form>
            
            <!-- Botão Exportar -->
            <a href="{{ url_for('export') }}?week={{ selected_week }}" class="btn">
                Exportar Excel
            </a>

            <!-- Botão Resetar Mês -->
            <form id="resetForm" method="POST" action="{{ url_for('reset_month') }}">
                <button type="button" onclick="confirmAction('reset', 'Isso irá marcar o início de um novo mês mantendo todos os dados. Continuar?')" class="btn warning">
                    Resetar Mês
                </button>
            </form>
        </div>
    </div>

    <script>
        // Função para confirmar ações importantes
        function confirmAction(action, message) {
            if (confirm(message)) {
                if (action === 'reset') {
                    document.getElementById('resetForm').submit();
                } else if (action === 'delete') {
                    document.getElementById('deleteAllForm').submit();
                }
            }
            return false;
        }
    </script>
</body>
</html>