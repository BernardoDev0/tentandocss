<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de {{ employee.real_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/employee_dashboard.css') }}">
    <!-- Chart.js e plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <!-- CSS inline para glass-table -->
    <style>
        :root {
            --text-primary: #f8fafc;
            --text-secondary: #e2e8f0;
            --glass-border: rgba(148,163,184,0.2);
            --radius-lg: 16px;
        }
        .glass-table{width:100%;border-collapse:collapse;background:rgba(30,41,59,0.35);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:var(--radius-lg);overflow:hidden}
        .glass-table th{padding:0.75rem 0.9rem;text-align:center;background:rgba(30,41,59,0.75);color:var(--text-primary);font-weight:600;font-size:0.9rem}
        .glass-table td{padding:0.65rem 0.9rem;border-bottom:1px solid rgba(148,163,184,0.15);color:var(--text-secondary);font-size:0.85rem}
        .glass-table tbody tr:hover{background:rgba(255,255,255,0.03)}
    </style>
</head>
<body class="dashboard-employee">
    <div class="container">
    <a href="{{ url_for('auth.index') }}" class="back-button">Voltar</a>
    
    <h1>Dashboard de {{ employee.real_name }}</h1>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="{{ category }}-message">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}
    
    <!-- Dashboard Cards -->
    <div class="week-selector">
    <form method="GET" action="{{ url_for('dashboard.employee_dashboard_enhanced') }}" class="week-form">
    <label for="week">Semana:</label>
    <select id="week" name="week" onchange="this.form.submit()">
      <option value="" {% if not selected_week %}selected{% endif %}>Todas</option>
      {% for week_num in range(1, 6) %}
        <option value="{{ week_num }}" {% if selected_week == week_num|string %}selected{% endif %}>Semana {{ week_num }}</option>
      {% endfor %}
    </select>
    </form>
    </div>
    <div class="dashboard-container">
    <!-- Pontos Diários -->
    <div class="dashboard-card">
    <h3>Pontos Hoje</h3>
    <div class="stat-value">{{ daily_points }}</div>
    <div class="stat-label">Meta diária: {{ employee.daily_goal }} pontos</div>
    <div class="progress-container">
    <div class="progress-bar-container">
    <div class="progress-bar progress-{{ 'green' if daily_percentage >= 100 else 'orange' if daily_percentage >= 50 else 'red' }}" 
    style="width: {{ daily_percentage }}%">
    </div>
    </div>
    <div class="progress-percentage">
    {{ daily_percentage|round(1) }}% da meta diária
    </div>
    </div>
    </div>
    
    <!-- Pontos Semanais -->
    <div class="dashboard-card">
    <h3>Pontos Semana {{ selected_week }}</h3>
    <div class="stat-value">{{ weekly_points }}</div>
    <div class="stat-label">Meta semanal: {{ employee.weekly_goal }} pontos</div>
    <div class="progress-container">
    <div class="progress-bar-container">
    <div class="progress-bar progress-{{ 'green' if weekly_percentage >= 100 else 'orange' if weekly_percentage >= 50 else 'red' }}" 
    style="width: {{ weekly_percentage }}%">
    </div>
    </div>
    <div class="progress-percentage">
    {{ weekly_percentage|round(1) }}% da meta semanal
    </div>
    </div>
    </div>
    
    <!-- Pontos Mensais -->
    <div class="dashboard-card">
    <h3>Pontos Mensais</h3>
    <div class="stat-value">{{ monthly_points }}</div>
    <div class="stat-label">Meta mensal: {{ employee.monthly_goal }} pontos</div>
    <div class="progress-container">
    <div class="progress-bar-container">
    <div class="progress-bar progress-{{ 'green' if monthly_percentage >= 100 else 'orange' if monthly_percentage >= 50 else 'red' }}" 
    style="width: {{ monthly_percentage }}%">
    </div>
    </div>
    <div class="progress-percentage">
    {{ monthly_percentage|round(1) }}% da meta mensal
    </div>
    </div>
    </div>
    </div>
    
    <!-- Tabs para diferentes visualizações -->
    <div class="tabs">
    <div class="tab" data-tab="evolution">Evolução Mensal</div>
    <div class="tab active" data-tab="register">Registrar Pontos</div>
    <div class="tab" data-tab="history">Histórico</div>
    </div>
    
    <!-- Conteúdo das Tabs -->
    <div id="evolution" class="tab-content">
    <h2>Evolução Mensal</h2>
    <div class="chart-container">
    <canvas id="monthlyChart"></canvas>
    </div>
    </div>
    
    <div id="register" class="tab-content active">
    <h2>Novo Registro</h2>
    <form method="POST" action="{{ url_for('api.register_points') }}">
    <label for="refinery">Refinaria:</label>
    <select id="refinery" name="refinery" required>
    <option value="{{ employee.default_refinery }}" selected>{{ employee.default_refinery }}</option>
    <option value="UTE-CBT">UTE-CBT</option>
    <option value="UTE-NPI">UTE-NPI</option>
    <option value="UTGCA">UTGCA</option>
    <option value="RPBC">RPBC</option>
    <option value="REVAP">REVAP</option>
    <option value="REPLAN">REPLAN</option>
    <option value="RECAP">RECAP</option>
    </select>
    
    <label for="points">Pontos:</label>
    <input type="number" id="points" name="points" required min="0">
    
    <label for="observations">Observações:</label>
    <textarea id="observations" name="observations" required></textarea>
    
    <input type="hidden" name="date" id="dateField">
    
    <button type="submit" class="btn">Registrar</button>
    <script>
      // Preencher data padrão (AAAA-MM-DD) no campo oculto
      document.addEventListener('DOMContentLoaded', function(){
          const field = document.getElementById('dateField');
          if(field){
              field.value = new Date().toISOString().slice(0,10);
          }
      });
    </script>
    </form>
    </div>
    
    <div id="history" class="tab-content">
    <h2>Seus Registros</h2>
    <div class="records-card" style="background:rgba(15,23,42,0.9);border:1px solid rgba(148,163,184,0.2);border-radius:16px;padding:1rem;overflow:auto">
        <table class="glass-table">
            <thead>
                <tr style="background:rgba(30,41,59,0.85)">
                    <th>Data</th>
                    <th>Horário</th>
                    <th>Refinaria</th>
                    <th>Pontos</th>
                    <th>Observações</th>
                </tr>
            </thead>
            <tbody>
            {% if entries %}
            {% for entry in entries %}
            <tr>
                <td>
                    {% if ' ' in entry.date %}
                        {% set date_part = entry.date.split(' ')[0] %}
                        {% set parts = date_part.split('-') %}
                        {{ parts[2] }}/{{ parts[1] }}/{{ parts[0] }}
                    {% else %}
                        {% set parts = entry.date.split('-') %}
                        {{ parts[2] }}/{{ parts[1] }}/{{ parts[0] }}
                    {% endif %}
                </td>
                <td>
                    {% if ' ' in entry.date and entry.date.split(' ')|length > 1 %}
                        {% set time_part = entry.date.split(' ')[1] %}
                        {% if ':' in time_part %}
                            {{ time_part[:5] }}
                        {% else %}
                            {{ time_part }}
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{{ entry.refinery }}</td>
                <td>{{ entry.points }}</td>
                <td>{{ entry.observations or '' }}</td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="5" style="text-align:center;padding:1rem">Nenhum registro encontrado.</td>
            </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
    </div>
    </div>
    
    <!-- Carregando o JavaScript externo -->
    <script src="{{ url_for('static', filename='js/chart-optimized.js') }}"></script>
    <script src="{{ url_for('static', filename='employee_dashboard.js') }}"></script>
    <script>
    // Dados para os gráficos
    var monthlyData = JSON.parse('{{ monthly_data|tojson|safe }}');
    var weeklyData = JSON.parse('{{ weekly_data|tojson|safe }}');
    
    // DEBUG: Log dos dados
    console.log('DEBUG: monthlyData =', monthlyData);
    console.log('DEBUG: weeklyData =', weeklyData);
    
    // Mostra toast se houver mensagem de sucesso
    document.addEventListener('DOMContentLoaded', function(){
        const successMsg = document.querySelector('.success-message');
        if(successMsg){
            successMsg.classList.add('toast');
        }
    });
    
    // Inicializar gráficos
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DEBUG: Inicializando gráficos...');
        console.log('DEBUG: monthlyData =', monthlyData);
        console.log('DEBUG: weeklyData =', weeklyData);
        initEmployeeDashboard(monthlyData, weeklyData);
    });
    </script>
</body>
</html>