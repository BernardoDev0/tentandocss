// ===== TESTE DE PERFORMANCE PARA ABA EXCEL =====

class ExcelPerformanceTest {
  constructor() {
    this.testResults = {
      before: null,
      after: null
    };
    
    this.init();
  }

  init() {
    console.log('üöÄ Teste de Performance da Aba Excel');
    console.log('üìã Comandos dispon√≠veis:');
    console.log('   window.excelTest.runBeforeTest() - Teste ANTES das otimiza√ß√µes');
    console.log('   window.excelTest.runAfterTest() - Teste DEPOIS das otimiza√ß√µes');
    console.log('   window.excelTest.compareResults() - Comparar resultados');
    console.log('   window.excelTest.autoTest() - Teste autom√°tico completo');
    console.log('   window.excelTest.testCardHover() - Testar hover nos cards');
    console.log('   window.excelTest.testChartPerformance() - Testar performance do gr√°fico');
  }

  async runBeforeTest() {
    console.log('üß™ Executando teste ANTES das otimiza√ß√µes da aba Excel...');
    
    // Remove otimiza√ß√µes temporariamente
    this.removeOptimizations();
    
    // Aguarda um pouco para estabilizar
    await this.delay(1000);
    
    const result = await this.measureExcelPerformance();
    this.testResults.before = result;
    
    console.log('üìä Resultados ANTES das otimiza√ß√µes:', result);
    return result;
  }

  async runAfterTest() {
    console.log('üß™ Executando teste DEPOIS das otimiza√ß√µes da aba Excel...');
    
    // Aplica otimiza√ß√µes
    this.applyOptimizations();
    
    // Aguarda um pouco para estabilizar
    await this.delay(1000);
    
    const result = await this.measureExcelPerformance();
    this.testResults.after = result;
    
    console.log('üìä Resultados DEPOIS das otimiza√ß√µes:', result);
    return result;
  }

  async measureExcelPerformance() {
    const excelCards = document.querySelectorAll('.excel-stat-card');
    const excelButtons = document.querySelectorAll('.excel-chart-container .glass-btn');
    const loadButton = document.getElementById('load-folder-btn');
    
    if (excelCards.length === 0) {
      console.log('‚ùå Nenhum card da aba Excel encontrado');
      return null;
    }

    const fpsHistory = [];
    const startTime = performance.now();
    const testDuration = 3000; // 3 segundos
    const testInterval = 100; // Teste a cada 100ms
    let testCount = 0;
    const maxTests = testDuration / testInterval;

    return new Promise((resolve) => {
      const testHover = () => {
        // Testa hover em cards alternados
        const currentCard = excelCards[testCount % excelCards.length];
        
        // Dispara hover
        currentCard.dispatchEvent(new MouseEvent('mouseenter', {
          bubbles: true,
          cancelable: true
        }));
        
        // Remove hover ap√≥s 50ms
        setTimeout(() => {
          currentCard.dispatchEvent(new MouseEvent('mouseleave', {
            bubbles: true,
            cancelable: true
          }));
        }, 50);
        
        // Mede FPS
        const currentTime = performance.now();
        const fps = 1000 / (currentTime - (window.lastExcelTestTime || currentTime));
        fpsHistory.push(fps);
        window.lastExcelTestTime = currentTime;
        
        testCount++;
        
        if (testCount < maxTests) {
          setTimeout(testHover, testInterval);
        } else {
          // Finaliza teste
          const avgFPS = fpsHistory.reduce((a, b) => a + b, 0) / fpsHistory.length;
          const minFPS = Math.min(...fpsHistory);
          const maxFPS = Math.max(...fpsHistory);
          
          resolve({
            avgFPS: Math.round(avgFPS),
            minFPS: Math.round(minFPS),
            maxFPS: Math.round(maxFPS),
            testCount: testCount,
            duration: testDuration,
            cardsTested: excelCards.length,
            buttonsTested: excelButtons.length
          });
        }
      };
      
      testHover();
    });
  }

  testCardHover() {
    console.log('üß™ Testando hover nos cards da aba Excel...');
    
    const excelCards = document.querySelectorAll('.excel-stat-card');
    if (excelCards.length === 0) {
      console.log('‚ùå Nenhum card da aba Excel encontrado');
      return;
    }
    
    console.log(`üéØ Encontrados ${excelCards.length} cards`);
    
    // Testa hover em cada card
    excelCards.forEach((card, index) => {
      setTimeout(() => {
        console.log(`üñ±Ô∏è Testando card ${index + 1}: ${card.querySelector('.stat-label')?.textContent || 'Card'}`);
        
        // Dispara hover
        card.dispatchEvent(new MouseEvent('mouseenter', {
          bubbles: true,
          cancelable: true
        }));
        
        // Remove hover ap√≥s 1 segundo
        setTimeout(() => {
          card.dispatchEvent(new MouseEvent('mouseleave', {
            bubbles: true,
            cancelable: true
          }));
        }, 1000);
      }, index * 1500); // Testa um card a cada 1.5 segundos
    });
    
    console.log('‚úÖ Teste de hover nos cards conclu√≠do');
  }

  testChartPerformance() {
    console.log('üß™ Testando performance do gr√°fico da aba Excel...');
    
    const chartCanvas = document.getElementById('excel-chart');
    if (!chartCanvas) {
      console.log('‚ùå Canvas do gr√°fico n√£o encontrado');
      return;
    }
    
    // Verifica se o gr√°fico est√° carregado
    if (window.ExcelDashboard && window.ExcelDashboard.state.chartInstance) {
      console.log('‚úÖ Gr√°fico carregado, testando intera√ß√µes...');
      
      // Simula intera√ß√µes com o gr√°fico
      const chart = window.ExcelDashboard.state.chartInstance;
      
      // Testa hover no gr√°fico
      const rect = chartCanvas.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      
      // Dispara evento de hover no centro do gr√°fico
      chartCanvas.dispatchEvent(new MouseEvent('mousemove', {
        clientX: centerX,
        clientY: centerY,
        bubbles: true
      }));
      
      console.log('‚úÖ Teste de intera√ß√£o com gr√°fico conclu√≠do');
    } else {
      console.log('‚ö†Ô∏è Gr√°fico n√£o carregado - carregue dados primeiro');
    }
  }

  applyOptimizations() {
    console.log('üîß Aplicando otimiza√ß√µes para aba Excel...');
    
    // Aplica patch CSS
    const style = document.createElement('style');
    style.textContent = `
      .excel-stat-card {
        transition: opacity 0.2s ease-out !important;
        will-change: opacity !important;
        transform: none !important;
        box-shadow: none !important;
        contain: layout style paint !important;
      }
      .excel-stat-card:hover {
        opacity: 0.9 !important;
        background: rgba(15, 23, 42, 0.98) !important;
        transform: none !important;
        box-shadow: none !important;
      }
      .excel-chart-container canvas {
        image-rendering: optimizeSpeed !important;
        will-change: auto !important;
        contain: layout style paint !important;
      }
      .excel-chart-container .glass-btn {
        transition: opacity 0.2s ease-out !important;
        will-change: opacity !important;
        transform: none !important;
        box-shadow: none !important;
      }
      .excel-chart-container .glass-btn:hover {
        opacity: 0.9 !important;
        transform: none !important;
        box-shadow: none !important;
      }
    `;
    document.head.appendChild(style);
    
    console.log('‚úÖ Otimiza√ß√µes aplicadas!');
  }

  removeOptimizations() {
    console.log('üîÑ Removendo otimiza√ß√µes da aba Excel...');
    
    // Remove estilos de otimiza√ß√£o
    const optimizationStyles = document.querySelectorAll('style');
    optimizationStyles.forEach(style => {
      if (style.textContent.includes('excel-stat-card') && 
          style.textContent.includes('!important')) {
        style.remove();
      }
    });
    
    console.log('‚úÖ Otimiza√ß√µes removidas!');
  }

  compareResults() {
    if (!this.testResults.before || !this.testResults.after) {
      console.log('‚ùå Execute os testes antes/depois primeiro');
      return;
    }

    const before = this.testResults.before;
    const after = this.testResults.after;
    
    console.log('üìä === COMPARA√á√ÉO DE RESULTADOS ABA EXCEL ===');
    console.log(`üìà FPS M√©dio: ${before.avgFPS} ‚Üí ${after.avgFPS} (${after.avgFPS - before.avgFPS > 0 ? '+' : ''}${after.avgFPS - before.avgFPS})`);
    console.log(`üìâ FPS M√≠nimo: ${before.minFPS} ‚Üí ${after.minFPS} (${after.minFPS - before.minFPS > 0 ? '+' : ''}${after.minFPS - before.minFPS})`);
    console.log(`üìä FPS M√°ximo: ${before.maxFPS} ‚Üí ${after.maxFPS} (${after.maxFPS - before.maxFPS > 0 ? '+' : ''}${after.maxFPS - before.maxFPS})`);
    console.log(`üéØ Cards testados: ${before.cardsTested}`);
    console.log(`üîò Bot√µes testados: ${before.buttonsTested}`);
    
    const improvement = ((after.avgFPS - before.avgFPS) / before.avgFPS * 100);
    
    if (improvement > 0) {
      console.log(`‚úÖ Melhoria: +${Math.round(improvement)}%`);
    } else {
      console.log(`‚ö†Ô∏è Piora: ${Math.round(improvement)}%`);
    }
    
    // An√°lise de performance
    if (after.avgFPS >= 55) {
      console.log('üéâ Performance EXCELENTE na aba Excel!');
    } else if (after.avgFPS >= 45) {
      console.log('‚úÖ Performance BOA na aba Excel');
    } else if (after.avgFPS >= 30) {
      console.log('üü° Performance REGULAR na aba Excel');
    } else {
      console.log('üî¥ Performance RUIM na aba Excel - mais otimiza√ß√µes necess√°rias');
    }
    
    console.log('==========================================');
  }

  async autoTest() {
    console.log('ü§ñ Iniciando teste autom√°tico completo da aba Excel...');
    
    console.log('\n1Ô∏è‚É£ Testando ANTES das otimiza√ß√µes...');
    await this.runBeforeTest();
    
    console.log('\n2Ô∏è‚É£ Aplicando otimiza√ß√µes...');
    this.applyOptimizations();
    
    console.log('\n3Ô∏è‚É£ Testando DEPOIS das otimiza√ß√µes...');
    await this.runAfterTest();
    
    console.log('\n4Ô∏è‚É£ Comparando resultados...');
    this.compareResults();
    
    console.log('\n‚úÖ Teste autom√°tico da aba Excel conclu√≠do!');
  }

  delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

// Inicializa o teste da aba Excel
window.excelTest = new ExcelPerformanceTest();

// ===== FIM DO TESTE DE PERFORMANCE PARA ABA EXCEL ===== 